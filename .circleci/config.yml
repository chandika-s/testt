version: 2.1
jobs:
  testjob:
    docker:
      - image: alpine:3.15

    environment:
      POSTGRES_HOST: 'chandika.tech'
      POSTGRES_PORT: '2209'
      MSG: 'How are you?'

    steps:
      - checkout
    #  - run:
        #  name: The First Step
        #  command: |
         #   echo 'Hello World!'
         #   echo 'This is the delivery pipeline'
      - run:
          name: Execute script
          command: |
            sh print.sh1
      
  send-start-notification:
    docker:
      - image: cimg/base:2024.01

    steps:
      - run:
          command: |
            message="ðŸŽ‰ A Staging deployment job has started: branch: ${CIRCLE_BRANCH}, job: ${CIRCLE_JOB}, url: ${CIRCLE_BUILD_URL}"
            echo $message
      - run:
          name: Notify Google Chat
          command: |
            curl -X POST -H 'Content-Type: application/json' \
            -d '{"text":"ðŸŽ‰ A Staging deployment job has started:\n branch: '${CIRCLE_BRANCH}', \n pipeline: '${CIRCLE_PIPELINE_ID}', \n url: '${CIRCLE_BUILD_URL}'"}' \
            "$GOOGLE_CHAT_WEBHOOK_URL"

    #  - run:
      #    command: |
      #      message="ðŸŽ‰ A Staging deployment job has started: branch: ${CIRCLE_BRANCH}, job: ${CIRCLE_JOB}, url: ${CIRCLE_BUILD_URL}"
      #      echo $message
      
     # - run:
      #    name: Notify Google Chat
       #   command: |
      #       curl -X POST -H "Content-Type: application/json" \
       #      -d "{\"text\":\"$message\"}" \
       #      "$GOOGLE_CHAT_WEBHOOK_URL"
       #   environment:
         #   message: "ðŸŽ‰ A Staging deployment job has started: branch: ${CIRCLE_BRANCH}, job: ${CIRCLE_JOB}, url: ${CIRCLE_BUILD_URL}"




workflows:
  testwf:
    jobs:
      - send-start-notification:
          filters: &filters-staging
            tags:
              only: /^test.*/
            branches:
              only: /^staging/sprint-.*/
                  
                  
      - production-deployment-approval:
          type: approval
          filters:
            <<: *filters-staging
              
      - testjob:
          filters:
            <<: *filters-staging
          post-steps:
            - run:
                name: send success notify
                command: |
                  curl -X POST -H 'Content-Type: application/json' \
                  -d '{"text":"ðŸŽ‰ A Staging deployment job has succeeded:\n branch: '${CIRCLE_BRANCH}', \n pipeline: '${CIRCLE_PIPELINE_ID}', \n url: '${CIRCLE_BUILD_URL}'"}' \
                  "$GOOGLE_CHAT_WEBHOOK_URL"
                when: on_success
            - run:
                name: send failure notify
                command: |
                  curl -X POST -H 'Content-Type: application/json' \
                  -d '{"text":"ðŸŽ‰ A Staging deployment job has failed:\n branch: '${CIRCLE_BRANCH}', \n pipeline: '${CIRCLE_PIPELINE_ID}', \n url: '${CIRCLE_BUILD_URL}'"}' \
                  "$GOOGLE_CHAT_WEBHOOK_URL"
                when: on_fail
        
