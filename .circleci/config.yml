version: 2.1
jobs:
  testjob:
    docker:
      - image: alpine:3.15

    environment:
      POSTGRES_HOST: 'chandika.tech'
      POSTGRES_PORT: '2209'
      MSG: 'How are you?'

    steps:
      - checkout
      - run:
          name: The First Step
          command: |
            echo 'Hello World!'
            echo 'This is the delivery pipeline'
      - run:
          name: Execute script
          command: |
            sh print.sh

  send-start-notification:
    docker:
      - image: cimg/base:2024.01

    steps:
      - run:
          name: Notify Google Chat
          command: |
            --data "{\"cards\":[{\"header\":{\"title\":\"Build ${CIRCLE_BUILD_NUM} passed.\",\"subtitle\":\"${CIRCLE_PROJECT_REPONAME}\",\"imageUrl\":\"https://png.pngtree.com/svg/20170510/success_404253.png\",\"imageStyle\":\"IMAGE\"},\"sections\":[{\"widgets\":[{\"keyValue\":{\"topLabel\":\"${CIRCLE_TAG}\",\"content\":\"${CIRCLE_SHA1}\"}}]},{\"widgets\":[{\"buttons\":[{\"textButton\":{\"text\":\"DETAILS\",\"onClick\":{\"openLink\":{\"url\":\"${CIRCLE_BUILD_URL}\"}}}}]}]}]}]}"  
            $GOOGLE_CHAT_WEBHOOK_URL


  send-success-notification:
    docker:
      - image: cimg/base:2024.01

    steps:
      - run:
          name: Notify Google Chat
          command: |
            curl -X POST -H "Content-Type: application/json" \
            -d '{"text": "ðŸŽ‰ *A Staging\/Production deployment job has succeeded!"}' \
            $GOOGLE_CHAT_WEBHOOK_URL


workflows:
  testwf:
    jobs:
      - send-start-notification:
          filters: &filters-staging
            tags:
              only: /^test.*/
            branches:
              only: /^staging/sprint-.*/
      - production-deployment-approval:
          type: approval
          filters:
            <<: *filters-staging
      - send-success-notification:
          filters: &filters-staging
            tags:
              only: /^test.*/
            branches:
              only: /^staging/sprint-.*/
              
      - testjob:
          filters:
            <<: *filters-staging
        
